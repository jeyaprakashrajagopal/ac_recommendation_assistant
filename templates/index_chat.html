<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AC Recommendation Assistant</title>
        <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
  </head>
  <body>
    <div class="outercontainer">
      <div class="center"> 
          <h1 id="titlestyle" >
              AC Recommendation Assistant!
          </h1>
      </div>
      <div class="conversationcontainer" id="chatcontainer">
          {% if conversations %}
          <div id="history">
              {% for item in conversations %}
                {% if item.user %}
                    <div class="user">{{ item.user }}</div>
                {% elif item.assistant %}
                    <div class="assistant">{{ item.assistant }}</div>
                {% endif %}
              {% endfor %}
          </div>
          {% endif %}
          <div id="chat">
          </div>
      </div>
      <form id="chat-form" method="POST" action="/chat_stream" class="center">
        <input name="user_input_message" id="user_input_message" autocomplete="off" placeholder="Type your message..." />
        <input type="image" value="" id="submitbutton">
        <div id="loader" class="mainloader" hidden="true"></div>
      </form>

      <form id="end-form" method="POST" action="/end_conv" class="center">
        <button type="submit" id="end">End Conversation</button>
      </form>
    </div>
    <script>
        const chat = document.getElementById('chat');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user_input_message');
        const submitbutton = document.getElementById('submitbutton');

        function showLoader() { 
          input.disabled = true;
          submitbutton.hidden = true;
          loader.style.display = 'block'; 
        }
        function hideLoader() { 
          input.disabled = false;
          submitbutton.hidden = false;
          loader.style.display = 'none'; 
        }
        function blockInput() {
          input.disabled = true;
          submitbutton.hidden = false;
          submitbutton.disabled = true;
          loader.style.display = 'none'; 
        }

        function append(role, text) {
          const div = document.createElement('div');
          div.className = role;
          div.textContent = text;
          chat.appendChild(div);
          // Scrolls down to the bottom of the chat window whenever message an element gets added
          requestAnimationFrame(scrollToBottom);
          chat.scrollTop = chat.scrollHeight;
        }

        async function streamPost(url, formData) {
          // sending form via HTTP and parses the streaming response here
          const response = await fetch(url, { method: 'POST', body: formData });
          if (!response.ok) {
            append('assistant', 'Error status: ' + response.status);
            return;
          }
          showLoader();
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          // Reading raw byte chunks from network
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            let index;
            // Splits raw chunks into expected event frames until read is done
            while ((index = buffer.indexOf("\n\n")) !== -1) {
              const raw = buffer.slice(0, index);
              buffer = buffer.slice(index + 2);

              let event = 'message';
              let data = '';
              for (const line of raw.split("\n")) {
                if (line.startsWith('event:')) {
                  event = line.slice(6).trim();
                }
                else if (line.startsWith('data:')) {
                  data += line.slice(5).trim();
                }
              }

              if (event === 'message') {
                try {
                  // Appends data (creates div elements) after parsing it
                  const message = JSON.parse(data);
                  append(message.role, message.text);
                } catch (error) {
                  hideLoader();
                  append('assistant', 'Message parsing error');
                }
              } else if (event === 'block') { // To block interaction with the user
                 blockInput();
                 return; 
              } else if (event === 'end') { // It is necessary to check if server sends event:end to terminate this loop
                hideLoader();
                return;
              }
            }
          }
        }
        // Listener is added to triggers streaming loop that reads Server Sent Events when form submission occurs
        form.addEventListener('submit', (error) => {
          error.preventDefault();
          const text = input.value.trim();
          if (!text) return;

          const formData = new FormData(form);
          streamPost('/chat_stream', formData);
          input.value = '';
          input.focus();
        });

        function scrollToBottom() {
            const element = document.getElementById("chatcontainer");
            if (!element) return;
            element.scrollTop = element.scrollHeight;
            document.getElementById('user_input_message').focus();
        }
        window.onload = scrollToBottom;
    </script>
  </body>
</html>