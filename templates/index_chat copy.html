<html>
    <head>
        <title>
            AC Recommendation Assistant!
        </title>
        <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
    </head>
    <body>
        <div class="outercontainer">
            <div class="center"> 
                <h1 id="titlestyle" >
                    AC Recommendation Assistant!
                </h1>
            </div>
            <div class="conversationcontainer" id="chatcontainer">
                <div id="chat">
                    <h2>
                        {% for entry in conversations %}
                        <div class="{% if entry.assistant %}bot{% else %}user{% endif %}">
                            {% if entry.assistant %}
                                {{ entry.assistant }}
                            {% else %}
                                {{ entry.user }} 
                            {% endif %}
                        </div>
                        {% endfor %}
                    </h2>
                </div>
            </div>
            <form action="/chat" method="POST" class="center" id="chat-form">
                <input type="text" name="user_input_message" id="inputtextbox">
                <input type="image" value= "" id="submitbutton"> 
            </form>
            <form action="/end_conv" method="POST" class="center">
                <button type="submit" id="end">END CONVERSATION</button> 
            </form>
        </div>
    <script>

        const form = document.getElementById('chat-form');
        const input = document.getElementById('inputtextbox');
        const chat = document.getElementById('chat');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const data = new FormData(form);

            // start a new SSE connection for this single request
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/chat');
            xhr.onloadstart = () => {
                // open EventSource via fetch-with-stream polyfill
            };
            // Use Fetch + ReadableStream to parse SSE (or switch to GET + EventSource if you pass querystring)
            fetch('/chat', { method: 'POST', body: data }).then(async (res) => {
                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                let buffer = '';
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });

                    // parse SSE lines
                    const parts = buffer.split("\n\n");
                    buffer = parts.pop();
                    for (const part of parts) {
                        const lines = part.split("\n");
                        let event = 'message', payload = '';
                        for (const line of lines) {
                        if (line.startsWith('event:')) event = line.slice(6).trim();
                        else if (line.startsWith('data:')) payload += line.slice(5).trim();
                        }
                        if (event === 'message') {
                            const msg = JSON.parse(payload);
                            const div = document.createElement('div');
                            div.textContent = (msg.role === 'user' ? 'You: ' : 'Assistant: ') + msg.text;
                            chat.appendChild(div);
                        } else if (event === 'end') {
                            return;
                        }
                    }
                }
            });

            input.value = '';
        });

        function scrollToBottom() {
            var element = document.getElementById("chatcontainer");
            element.scrollTop = element.scrollHeight;
            var inputtextbox = document.getElementById("inputtextbox");
            inputtextbox.focus();
        }
        window.onload = scrollToBottom;
    </script>
    </body>
</html>